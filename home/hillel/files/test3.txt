



-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);





























-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);








-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);







-- 1.1 HouseHold_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (8671, 8672)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('13823795', '94228', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 94228, consumer = 70436, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 94228
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 94228
	--AND date >= '2021-09-06'
	AND drh.reading_source = 5;







-- 2.1 Industrial_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (7968, 7967)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	Left JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('20784943', '92532', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3441695, 3441696);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3441695, 3441696);


UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 17:31:13.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 3
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 3, is_reading_deleted = 1, source_version = '63758060834920', metering_unit = 92532, consumer = 68341, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 92532
				AND drh.reading_source = 5
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 2477994.00, 7967, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 233715.00, 7968, 0, '63768955212931', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 92532
	AND date >= '2021-08-01'
	--AND drh.value  is null
	AND drh.reading_source in(5,5);









-- 3.1 Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (198582, 169686)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id as typy_size
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	LEFT JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '129308', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 129308, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 129308
				AND drh.reading_source = 3
			);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 3594267.01, 169686, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

INSERT INTO [dbo].[devices_readings_history] (date, reading_source, reading_type, value, device, is_rejected_reading_value, source_version, reading_accounting_period, is_reading_deleted, reading_factor, metering_unit, consumer, reading_status)
VALUES ('2021-09-01 19:57:55.000', 5, 1, 594267.02, 198582, 0, '63758060782358', '2021-08-31', 0, 1, 92532, 68341, 1);

*/


SELECT drh.id
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 129308
	AND date >= '2021-09-06'
	AND drh.reading_source in(5,7);








-- 4.1 Inductrial_Corrector_2_devices - Lviv

USE RGCAIDB;

WITH devices_ordered_by_date as (
							SELECT drh.*
								  ,ROW_NUMBER() OVER(PARTITION BY drh.device, drh.reading_source ORDER BY drh.date DESC) as desc_row
							FROM [dbo].[devices_readings_history] drh
							WHERE drh.device in (
												SELECT md.id
												FROM [dbo].[metering_devices] md
												WHERE md.id in (56565, 56566)
												)
								and drh.reading_source in(5,7)
							)
SELECT dobd.*
      ,rc.name
	  ,md.metering_device_bitness
	  ,mdt.external_id
      ,drhl.file_link
FROM devices_ordered_by_date dobd
	LEFT JOIN [dbo].[readings_history_file_links] drhl on drhl.id_history_device = dobd.id
	JOIN [dbo].[reading_sources] rc on rc.id = dobd.reading_source
	JOIN [dbo].[metering_devices] md on md.id = dobd.device
	JOIN [dbo].[metering_device_typesizes] mdt on mdt.id = md.metering_device_typesize
WHERE dobd.desc_row <= 1
ORDER BY dobd.device
		,dobd.date DESC;
​
​
SELECT *
FROM api_get_client_metering_devices_last_meterage_by_meter_ids_v2('05800293', '98512', null);

/*

UPDATE [dbo].[devices_readings_history]
SET reading_accounting_period = '2021-08-01', date = '2021-08-01 13:31:13.000', is_reading_deleted = 0
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND date >= '2021-09-06'
				AND drh.reading_source = 7
			);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-09-30', date = '2021-10-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-07-31', date = '2021-08-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-06-30', date = '2021-07-01 19:57:55.000'
WHERE id in (3410802, 3410801);

UPDATE [dbo].[devices_readings_history]
SET reading_source = 5, is_reading_deleted = 0, source_version = '63758060834920', metering_unit = 98512, consumer = 65664, reading_status = 1, reading_accounting_period = '2021-08-31', date = '2021-09-01 19:57:55.000'
WHERE id in (
			SELECT drh.id
			FROM [dbo].[devices_readings_history] drh
			WHERE drh.metering_unit = 98512
				AND drh.reading_source = 3
			);

*/

SELECT drh.*
FROM [dbo].[devices_readings_history] drh
WHERE drh.metering_unit = 98512
	AND date >= '2021-09-06'
	--AND drh.value  is null
	AND drh.reading_source in(5,7);

























